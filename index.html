<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mémento opérationnel IA – RCH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Police Inter -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <!-- Styles de l'application -->
  <link rel="stylesheet" href="style.css" />

  <!-- Lib pour scan QR (caméra + fichier) -->
  <!-- IMPORTANT : chemin conforme à la doc officielle -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Lib pour compression DEFLATE + Base64 (pako) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js" integrity="sha512-i7WVr6f5xKaZlbJOmzuza8ngZ0IeBB2EVuPrrJNQtYrxq86C2fILW+QFBvXFi40ieEV3W1VTwCy0eNI6fCHTkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Lib pour génération de QR code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-J7y8xU6ZzGvZx8r4KqqScw5pO8kP2t0XEj2a7l+E5W6DqC4Wsbz5L0uP7u2c1tG+Z2Tt2q+X9bTzVt3ZDW3U2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="app-root">
    <!-- En-tête -->
    <header class="app-header">
      <div class="header-left">
        <img src="logo-ensosp.png" alt="ENSOSP" class="logo-ensosp" />
        <div>
          <div class="header-title-main">Mémento opérationnel IA – Risque Chimique</div>
          <div class="header-title-sub">Prototype – ENSOSP / Filière NRBC</div>
        </div>
      </div>
      <div class="header-right">
        <span class="header-badge">Version prototype</span>
      </div>
    </header>

    <!-- Contenu principal -->
    <main class="app-main">
      <!-- Onglets -->
      <div class="tabs">
        <button class="tab-button active" data-tab="scanTab">Lire une fiche (scan QR)</button>
        <button class="tab-button" data-tab="createTab">Créer / éditer une fiche</button>
      </div>

      <!-- Contenu des onglets -->
      <div class="tab-content active" id="scanTab">
        <section class="section">
          <h2>Lecture d'une fiche opérationnelle via QR code</h2>
          <p class="section-intro">
            Scannez un QR code (caméra ou fichier image) pour charger une fiche opérationnelle
            et générer automatiquement un prompt à destination des IA référencées.
          </p>

          <div class="cards-layout">

            <!-- Colonne gauche -->
            <div class="card">
              <div class="card-section">
                <div class="button-row">
                  <button id="cameraBtn" class="btn btn-primary">
                    Activer la caméra
                  </button>
                  <button id="resetBtn" class="btn btn-secondary">
                    Réinitialiser
                  </button>
                </div>

                <div id="cameraError" class="alert alert-error" hidden></div>

                <div id="videoBox" class="video-box" hidden>
                  <div id="videoContainer" class="video-container">
                    <div id="reader" class="video-element"></div>
                    <div id="scanOverlay" class="scan-overlay"></div>
                  </div>
                  <p id="scanHint" class="scan-hint">
                    Placez le QR code dans le carré. La lecture est automatique.
                  </p>
                </div>

                <div class="file-input-row">
                  <label for="qrFile" class="file-label">ou importer une image de QR code</label>
                  <input type="file" id="qrFile" accept="image/*" />
                </div>
              </div>

              <div class="card-section">
                <h3>Informations sur la fiche</h3>
                <div id="ficheMeta" class="fiche-meta fiche-meta--empty">
                  Aucune fiche scannée
                </div>
              </div>

              <div class="card-section">
                <h3>Variables à renseigner</h3>
                <div id="variablesContainer" class="variables-container">
                  <!-- Champs générés dynamiquement -->
                </div>
              </div>
            </div>

            <!-- Colonne droite -->
            <div class="card">
              <div class="card-section">
                <h3>Informations complémentaires (contexte, situation, contraintes…)</h3>
                <textarea
                  id="infosComplementaires"
                  rows="6"
                  class="textarea"
                  placeholder="Exemples : description du site, conditions météo, moyens engagés, contraintes particulières…"
                ></textarea>
              </div>

              <div class="card-section">
                <div class="generate-row">
                  <button id="generatePromptBtn" class="btn btn-primary">
                    Générer le prompt
                  </button>
                  <span id="successMsg" class="success-msg" hidden>Prompt mis à jour</span>
                </div>
                <textarea
                  id="compiledPrompt"
                  rows="10"
                  class="textarea textarea-mono"
                  placeholder="Le prompt généré apparaîtra ici."
                  readonly
                ></textarea>
              </div>

              <div class="card-section">
                <h3>Envoyer vers une IA</h3>
                <p class="section-intro">
                  Après avoir généré le prompt, choisissez une IA&nbsp;:
                </p>
                <div class="button-row">
                  <button id="btnChatgpt" class="btn btn-ia" disabled>ChatGPT</button>
                  <button id="btnPerplexity" class="btn btn-ia" disabled>Perplexity</button>
                  <button id="btnMistral" class="btn btn-ia" disabled>Mistral</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="tab-content" id="createTab">
        <section class="section">
          <h2>Création / édition d'une fiche opérationnelle</h2>
          <p class="section-intro">
            Définissez les métadonnées de la fiche, son objectif, ses champs d'entrée et le prompt
            associé. Un QR code JSON compacté sera généré automatiquement.
          </p>

          <div class="cards-layout">
            <!-- Colonne gauche : définition de la fiche -->
            <div class="card">
              <div class="card-section">
                <h3>Métadonnées de la fiche</h3>
                <div class="form-grid">
                  <div class="form-field">
                    <label for="ficheTitre">Titre de la fiche</label>
                    <input id="ficheTitre" type="text" class="input" placeholder="Ex. : Analyse produit" />
                  </div>
                  <div class="form-field">
                    <label for="ficheVersion">Version</label>
                    <input id="ficheVersion" type="text" class="input" placeholder="Ex. : V0.1" />
                  </div>
                  <div class="form-field">
                    <label for="ficheCategorie">Catégorie</label>
                    <input id="ficheCategorie" type="text" class="input" placeholder="Ex. : Analyse / Synthèse" />
                  </div>
                  <div class="form-field">
                    <label for="ficheObjectif">Objectif opérationnel</label>
                    <textarea
                      id="ficheObjectif"
                      rows="3"
                      class="textarea"
                      placeholder="Ex. : Réaliser l'analyse d'un produit chimique à partir de ses identifiants."
                    ></textarea>
                  </div>
                  <div class="form-field">
                    <label for="ficheRefs">Références / sources à citer</label>
                    <textarea
                      id="ficheRefs"
                      rows="3"
                      class="textarea"
                      placeholder='Ex. : INRS, guide SPG, ADR, NIOSH, BIG, INERIS, CAMEO Chemicals, base ARIA…'
                    ></textarea>
                  </div>
                </div>
              </div>

              <div class="card-section">
                <h3>Champs d'entrée (variables)</h3>
                <p class="section-intro">
                  Définissez les variables demandées à l'utilisateur : code ONU, produit, contexte, etc.
                </p>
                <div id="variablesBuilder" class="variables-builder">
                  <!-- Lignes de variables ajoutées dynamiquement -->
                </div>
                <div class="button-row">
                  <button id="addVariableBtn" class="btn btn-secondary">Ajouter un champ</button>
                </div>
              </div>
            </div>

            <!-- Colonne droite : prompt & QR -->
            <div class="card">
              <div class="card-section">
                <h3>Prompt associé à la fiche</h3>
                <p class="section-intro">
                  Rédigez le prompt en intégrant les variables entre <code>{{ }}</code>. Exemple :
                  <code>{{nom_produit}}</code>, <code>{{code_onu}}</code>, etc.
                </p>
                <textarea
                  id="fichePrompt"
                  rows="10"
                  class="textarea textarea-mono"
                  placeholder='Ex. : "Tu es assistant de niveau RCH4. Analyse {{nom_produit}} (ONU {{code_onu}}, ADR {{code_danger_adr}}, CAS {{num_cas}}) selon..."'
                ></textarea>
              </div>

              <div class="card-section">
                <h3>JSON & QR code</h3>
                <p class="section-intro">
                  Le JSON compacté (wrapper pako-base64-v1) et le QR code sont générés automatiquement.
                </p>

                <div class="form-field">
                  <label for="ficheJson">JSON compacté</label>
                  <textarea
                    id="ficheJson"
                    rows="10"
                    class="textarea textarea-mono"
                    readonly
                    placeholder="Le JSON compacté de la fiche apparaîtra ici."
                  ></textarea>
                </div>

                <div class="qr-preview-container">
                  <div id="qrcode" class="qr-preview"></div>
                  <div class="qr-info">
                    <p id="qrSizeInfo" class="qr-size-info">
                      Longueur texte : 0 caractères – taille QR dynamique.
                    </p>
                    <button id="downloadQrBtn" class="btn btn-secondary">
                      Télécharger le QR code
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <span>Prototype pédagogique – ENSOSP / Filière NRBC / Mémento IA RCH</span>
    </footer>
  </div>

  <!-- Script principal de l'application -->
  <script src="app.js"></script>
</body>
</html>
